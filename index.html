<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Itinerary — Van + Rail</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    html, body { height: 100%; }
    #map { height: 55vh; }
    .seg-badge { font-size: 0.72rem; }
    .seg-road { background: #2563eb; color: #fff; }
    .seg-train { background: #059669; color: #fff; }
    .seg-walk { background: #6b7280; color: #fff; }
    .leaflet-popup { pointer-events: auto; }
    .tab-active { border-bottom: 2px solid #111827; color: #111827; }
    .tab-inactive { color: #6b7280; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-40 bg-white/95 backdrop-blur border-b border-gray-200">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex items-center gap-3 py-3">
        <div class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 13.5l7.5-7.5 6 6L21 7.5"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 20.25h18"/></svg>
          <h1 class="text-lg sm:text-xl font-semibold">Trip Itinerary — Van + Rail</h1>
        </div>
        <nav class="ml-auto flex items-end gap-5 text-sm">
          <button data-tab="itinerary" class="tab-btn tab-active pb-2">Itinerary</button>
          <button data-tab="van" class="tab-btn tab-inactive pb-2">Van</button>
          <button data-tab="about" class="tab-btn tab-inactive pb-2">About</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-20">
    <section id="tab-itinerary" class="pt-4">
      <div class="bg-white rounded-2xl shadow p-3 sm:p-4">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <div class="flex items-center gap-2">
            <label for="filterMode" class="text-sm text-gray-700 whitespace-nowrap">Show:</label>
            <select id="filterMode" class="text-sm border rounded-md px-2 py-1">
              <option value="all">All</option>
              <option value="road_train">Road (Drive) + Train</option>
              <option value="city_walk">City / Walk-Transit</option>
            </select>
          </div>
          <div class="text-xs text-gray-500 sm:ml-auto">Polyline can be encoded or raw coordinates. Empty = dashed straight line.</div>
        </div>
        <div id="map" class="rounded-xl mt-3"></div>
        <p class="mt-2 text-xs text-gray-500">Map tiles © OpenStreetMap contributors. Keep usage light.</p>
      </div>

      <div id="days" class="mt-4 space-y-4"></div>
    </section>

    <section id="tab-van" class="hidden pt-6">
      <div id="vanCard" class="bg-white rounded-2xl shadow p-5"></div>
    </section>

    <section id="tab-about" class="hidden pt-6">
      <article class="bg-white rounded-2xl shadow p-5 space-y-3 text-sm leading-6">
        <h2 class="text-lg font-semibold">About this site</h2>
        <p>Static single-file site. Data is loaded from <code>/data/itinerary_spec.txt</code> (JSON) or <code>/data/itinerary_spec.json</code> if present. If both are missing, it falls back to a tiny inline demo.</p>
        <ul class="list-disc pl-5">
          <li>Update trip details by editing the <code>data/</code> file in your repo (no rebuild needed).</li>
          <li>Segments support: encoded polyline string OR array of <code>[lat,lng]</code> pairs.</li>
          <li>If a segment has no polyline and no from/to IDs, it is skipped.</li>
        </ul>
      </article>
    </section>
  </main>

  <!-- Minimal inline fallback, used only if no external file exists -->
  <script id="fallback-spec" type="application/json">
  {"meta":{"date_anchor":"2026-08-27","timezone":"Asia/Jerusalem"},"days":[{"title":"Demo Day — Chicago","points":[{"id":"millennium_park","name":"Millennium Park","type":"city_landmark","coords":[41.8826,-87.6226],"stay_duration_min":90}],"segments":[{"mode":"walk","polyline":""}]}]}
  </script>

  <script>
    // Helpers
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    function decodePolyline(str) {
      if (!str || typeof str !== 'string') return null;
      let index = 0, lat = 0, lng = 0, coords = [];
      while (index < str.length) {
        let b, shift = 0, result = 0;
        do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
        const dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
        lat += dlat;
        shift = 0; result = 0;
        do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
        const dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
        lng += dlng;
        coords.push([lat*1e-5, lng*1e-5]);
      }
      return coords;
    }

    function segBadge(mode) {
      if (mode === 'train') return '<span class="seg-badge seg-train rounded px-2 py-0.5">Train</span>';
      if (mode === 'drive' || mode === 'rv' || mode === 'road') return '<span class="seg-badge seg-road rounded px-2 py-0.5">Drive</span>';
      return '<span class="seg-badge seg-walk rounded px-2 py-0.5">Walk/City</span>';
    }
    function segColor(mode) {
      if (mode === 'train') return '#059669';
      if (mode === 'drive' || mode === 'rv' || mode === 'road') return '#2563eb';
      return '#6b7280';
    }
    function shouldShow(mode, filter) {
      if (filter === 'all') return true;
      if (filter === 'road_train') return (mode === 'drive' || mode === 'rv' || mode === 'road' || mode === 'train');
      if (filter === 'city_walk') return !(mode === 'drive' || mode === 'rv' || mode === 'road' || mode === 'train');
      return true;
    }

    async function loadData() {
      async function tryFetch(url) {
        try { const res = await fetch(url, {cache:'no-store'}); if (!res.ok) throw 0; return await res.json(); } catch { return null; }
      }
      // try .txt (JSON content), then .json, else fallback
      return (await tryFetch('./data/itinerary_spec.txt'))
          || (await tryFetch('./data/itinerary_spec.json'))
          || JSON.parse($('#fallback-spec').textContent);
    }

    const state = { data:null, map:null, layers:{points:[], segments:[]}, lastFilter:'all' };

    function initMap() {
      state.map = L.map('map', { zoomControl:true, closePopupOnClick:false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom:19,
        attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
      }).addTo(state.map);
      state.map.setView([39.5,-98.35], 4);
    }

    function clearMap() {
      state.layers.points.forEach(l=>l.remove());
      state.layers.segments.forEach(l=>l.remove());
      state.layers.points = [];
      state.layers.segments = [];
    }

    function getPointById(id) {
      if (!id) return null;
      for (const day of state.data.days||[]) {
        const p = (day.points||[]).find(pp=>pp.id===id);
        if (p) return p;
      }
      return null;
    }

    function toLatLngs(poly) {
      if (!poly) return null;
      if (typeof poly === 'string') return decodePolyline(poly);
      if (Array.isArray(poly)) {
        // Validate pairs; accept {lat,lng} objects too
        return poly.map(pt => Array.isArray(pt) ? [pt[0], pt[1]] : [pt.lat, pt.lng]).filter(v=>Array.isArray(v) && v.length===2 && v[0]!=null && v[1]!=null);
      }
      return null;
    }

    function renderMap(filter='all') {
      clearMap();
      const bounds = L.latLngBounds([]);

      // markers
      (state.data.days||[]).forEach(day=>{
        (day.points||[]).forEach(p=>{
          const c = p.coords;
          const lat = Array.isArray(c) ? c[0] : (c && c.lat);
          const lng = Array.isArray(c) ? c[1] : (c && c.lng);
          if (lat==null || lng==null) return; // skip missing coords
          const m = L.marker([lat,lng]).addTo(state.map);
          const links = p.links && typeof p.links==='object'
              ? Object.entries(p.links).map(([k,v])=>`<a class="text-blue-600 underline text-xs" target="_blank" rel="noopener" href="${v}">${k}</a>`).join(' ')
              : '';
          m.bindPopup(`
            <div class="space-y-1">
              <div class="font-semibold">${p.name||'Point'}</div>
              <div class="text-xs text-gray-600">${p.type||''}${p.stay_duration_min?` • ~${p.stay_duration_min} min`:''}</div>
              <div class="text-xs">${p.description||''}</div>
              <div class="flex gap-2 flex-wrap mt-1">${links||''}</div>
            </div>
          `, {autoClose:false, closeButton:true});
          state.layers.points.push(m);
          bounds.extend([lat,lng]);
        });
      });

      // segments
      (state.data.days||[]).forEach(day=>{
        (day.segments||[]).forEach(seg=>{
          const mode = (seg.mode||'').toLowerCase();
          if (!shouldShow(mode, filter)) return;

          let latlngs = toLatLngs(seg.polyline);
          let dashed = false;

          if (!latlngs || latlngs.length<2) {
            const a = getPointById(seg.from_point_id);
            const b = getPointById(seg.to_point_id);
            if (a?.coords && b?.coords) {
              const aC = Array.isArray(a.coords) ? a.coords : [a.coords.lat, a.coords.lng];
              const bC = Array.isArray(b.coords) ? b.coords : [b.coords.lat, b.coords.lng];
              latlngs = [aC, bC];
              dashed = true;
            }
          }

          if (latlngs && latlngs.length>=2) {
            const line = L.polyline(latlngs, {
              color: segColor(mode),
              weight:4,
              opacity:0.95,
              dashArray: dashed ? '6,8' : (Array.isArray(seg.polyline) && seg.polyline.length<3 ? '6,8' : null)
            }).addTo(state.map);
            line.bindPopup(`<div>${segBadge(mode)} <span class="ml-2 text-xs text-gray-600">${day.title||''}</span></div>`, {autoClose:false});
            state.layers.segments.push(line);
            latlngs.forEach(ll=>bounds.extend(ll));
          }
        });
      });

      if (bounds.isValid()) state.map.fitBounds(bounds.pad(0.2));
    }

    function renderDays() {
      const root = $('#days'); root.innerHTML='';
      (state.data.days||[]).forEach((day, i)=>{
        const segBadges = (day.segments||[]).map(s=>segBadge((s.mode||'').toLowerCase())).join(' ');
        const pts = (day.points||[]).map(p=>{
          const dur = p.stay_duration_min?` • ~${p.stay_duration_min} min`:'';
          return `
          <li class="flex items-start gap-3">
            <div class="w-2 h-2 rounded-full bg-gray-400 mt-2"></div>
            <div>
              <div class="font-medium">${p.name||'Point'}</div>
              <div class="text-xs text-gray-600">${p.type||''}${dur}</div>
              <div class="text-sm">${p.description||''}</div>
            </div>
          </li>`;
        }).join('');

        const sleep = day.summary?.sleep ? day.summary.sleep : '—';

        const card = document.createElement('article');
        card.className = 'bg-white rounded-2xl shadow p-4';
        card.innerHTML = `
          <div class="flex items-center gap-2 mb-2">
            <h3 class="text-lg font-semibold">${day.title || ('Day ' + (i+1))}</h3>
            <div class="ml-auto flex items-center gap-2">${segBadges}</div>
          </div>
          <ul class="space-y-3">${pts}</ul>
          <div class="mt-3 text-sm text-gray-600"><span class="font-medium">Sleep:</span> ${sleep}</div>
        `;
        root.appendChild(card);
      });
    }

    function renderVan() {
      const v = state.data?.meta?.van;
      const el = $('#vanCard');
      if (!v) { el.innerHTML = '<div class="text-sm text-gray-600">No van data in spec.</div>'; return; }
      el.innerHTML = `
        <div class="space-y-2">
          <h2 class="text-xl font-semibold">Van Details</h2>
          <pre class="text-xs bg-gray-50 p-3 rounded border overflow-x-auto">${JSON.stringify(v, null, 2)}</pre>
          <p class="text-sm text-gray-600">Customize this section once van fields are finalized.</p>
        </div>
      `;
    }

    $('#filterMode').addEventListener('change', e=>{ state.lastFilter = e.target.value; renderMap(state.lastFilter); });
    $$('.tab-btn').forEach(btn=>btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab;
      $$('.tab-btn').forEach(b=>{
        const active = b.dataset.tab===tab;
        b.classList.toggle('tab-active', active);
        b.classList.toggle('tab-inactive', !active);
      });
      $('#tab-itinerary').classList.toggle('hidden', tab!=='itinerary');
      $('#tab-van').classList.toggle('hidden', tab!=='van');
      $('#tab-about').classList.toggle('hidden', tab!=='about');
      if (tab==='itinerary' && state.map) setTimeout(()=>state.map.invalidateSize(), 100);
    }));

    (async function init(){
      state.data = await loadData();
      // Backward-compat: if date anchor missing, set a safe default (per project spec default)
      if (!state.data.meta) state.data.meta = {};
      if (!state.data.meta.date_anchor) state.data.meta.date_anchor = '2026-08-27';
      initMap();
      renderDays();
      renderMap(state.lastFilter);
      renderVan();
    })();
  </script>
</body>
</html>