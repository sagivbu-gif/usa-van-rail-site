<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>USA Van+Rail – Trip Map</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/@mapbox/polyline@1.2.1/dist/polyline.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>html,body{height:100%}#map{height:100%}.leaflet-popup-content-wrapper{border-radius:.75rem}</style>
</head>
<body class="h-screen w-screen bg-white text-slate-900">
  <div class="flex h-full">
    <aside class="w-full sm:w-96 border-r border-slate-200 overflow-y-auto">
      <div class="p-4 sticky top-0 bg-white/90 backdrop-blur z-40 border-b">
        <h1 class="text-xl font-semibold">USA Van + Rail Itinerary</h1>
        <p class="text-sm text-slate-600">Anchor: 2026‑08‑27 · Local times per city</p>
      </div>
      <div id="days" class="p-3 space-y-3"></div>
    </aside>
    <main class="flex-1 relative">
      <div id="map" class="h-full w-full"></div>
      <div id="legend" class="absolute top-3 right-3 z-50 bg-white shadow-lg rounded-2xl p-3 w-64 space-y-2 border border-slate-200">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Filters</h2><button id="resetBtn" class="text-sm underline">Reset</button>
        </div>
        <div class="space-y-2 text-sm">
          <label class="flex items-center gap-2"><input id="chkRoad" type="checkbox" class="accent-slate-700" checked /><span>Show Road (Van)</span></label>
          <label class="flex items-center gap-2"><input id="chkRail" type="checkbox" class="accent-slate-700" checked /><span>Show Rail</span></label>
          <label class="flex items-center gap-2"><input id="chkHike" type="checkbox" class="accent-slate-700" checked /><span>Show Hike</span></label>
          <hr />
          <label class="flex items-center gap-2"><input id="scenicPref" type="checkbox" class="accent-slate-700" checked /><span>Prefer Scenic when similar time</span></label>
          <label class="flex items-center gap-2"><input id="noTolls" type="checkbox" class="accent-slate-700" /><span>No Tolls (if alt route exists)</span></label>
        </div>
      </div>
    </main>
  </div>
  <script>
    const state={map:null,layers:{road:L.layerGroup(),rail:L.layerGroup(),hike:L.layerGroup(),points:L.layerGroup()},spec:null};
    function initMap(){state.map=L.map('map',{zoomControl:true});L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(state.map);state.layers.road.addTo(state.map);state.layers.rail.addTo(state.map);state.layers.hike.addTo(state.map);state.layers.points.addTo(state.map);state.map.setView([39.8283,-98.5795],4)}
    function popupHtml(p){return `<div class="min-w-[200px]"><div class="font-semibold">${p.name}</div><div class="text-xs text-slate-600 mt-1">Type: ${p.type} · Stay: ${p.stay_duration_min} min</div><div class="text-sm mt-2">${p.description||''}</div></div>`}
    function addPoints(points){(points||[]).forEach(p=>{if(!p.coords)return;const m=L.marker([p.coords.lat,p.coords.lng],{riseOnHover:true});m.bindPopup(popupHtml(p),{autoClose:false,closeOnClick:false});m.on('click',e=>{e.originalEvent?.stopPropagation?.();m.openPopup()});m.addTo(state.layers.points)})}
    function decodePolyline(enc){try{return polyline.decode(enc).map(([lat,lng])=>[lat,lng])}catch(e){console.warn('Polyline decode failed',e);return null}}
    async function routeRoad(fromPt,toPt){if(!fromPt?.coords||!toPt?.coords)return null;const coords=`${fromPt.coords.lng},${fromPt.coords.lat};${toPt.coords.lng},${toPt.coords.lat}`;const url=`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=polyline`;try{const r=await fetch(url);const j=await r.json();if(j?.routes?.[0]?.geometry){const ll=decodePolyline(j.routes[0].geometry);if(ll)L.polyline(ll,{color:'#1e293b',weight:3}).addTo(state.layers.road);return}}catch(e){console.warn('OSRM route failed',e)}const ll=[[fromPt.coords.lat,fromPt.coords.lng],[toPt.coords.lat,toPt.coords.lng]];L.polyline(ll,{color:'#1e293b',weight:2,dashArray:'6 6'}).addTo(state.layers.road)}
    function drawStraight(fromPt,toPt,layer,color){if(!fromPt?.coords||!toPt?.coords)return;const ll=[[fromPt.coords.lat,fromPt.coords.lng],[toPt.coords.lat,toPt.coords.lng]];L.polyline(ll,{color,weight:2,dashArray:'6 6'}).addTo(layer)}
    async function addSegments(day,byId){for(const seg of (day.segments||[])){const from=byId[seg.from];const to=byId[seg.to];if(!from||!to)continue;if(seg.mode==='road'){await routeRoad(from,to)}else if(seg.mode==='rail'){if(typeof seg.polyline==='string'&&seg.polyline.length>0){const ll=decodePolyline(seg.polyline);if(ll)L.polyline(ll,{color:'#6b21a8',weight:3}).addTo(state.layers.rail)}else{drawStraight(from,to,state.layers.rail,'#6b21a8')}}else if(seg.mode==='hike'){if(typeof seg.polyline==='string'&&seg.polyline.length>0){const ll=decodePolyline(seg.polyline);if(ll)L.polyline(ll,{color:'#16a34a',weight:3}).addTo(state.layers.hike)}else if(Array.isArray(seg.polyline)&&seg.polyline.length>0){const ll=seg.polyline.map(c=>[c.lat,c.lng]);L.polyline(ll,{color:'#16a34a',weight:3}).addTo(state.layers.hike)}else{drawStraight(from,to,state.layers.hike,'#16a34a')}}else if(seg.mode==='transit'){drawStraight(from,to,state.layers.points,'#64748b')}}}
    function byId(points){const m={};(points||[]).forEach(p=>m[p.id]=p);return m}
    function buildDayCard(day){const el=document.createElement('div');el.className="border border-slate-200 rounded-xl p-3 shadow-sm";const pts=(day.points||[]).map(p=>`• ${p.name}`).join('<br/>');el.innerHTML=`<div class="flex items-center justify-between gap-2"><div><div class="text-sm text-slate-500">Day ${day.day} · ${day.date}</div><div class="font-semibold">${day.title}</div></div><button class="px-3 py-1 text-sm border rounded-lg hover:bg-slate-50">Zoom</button></div><div class="text-sm mt-2">${pts}</div>`;el.querySelector('button').addEventListener('click',()=>{const pts=(day.points||[]).filter(p=>p.coords);if(pts.length){const g=L.featureGroup(pts.map(p=>L.marker([p.coords.lat,p.coords.lng])));state.map.fitBounds(g.getBounds().pad(0.3),{animate:true})}});return el}
    function applyFilters(){const r=document.getElementById('chkRoad').checked;const rl=document.getElementById('chkRail').checked;const h=document.getElementById('chkHike').checked;if(r)state.layers.road.addTo(state.map);else state.map.removeLayer(state.layers.road);if(rl)state.layers.rail.addTo(state.map);else state.map.removeLayer(state.layers.rail);if(h)state.layers.hike.addTo(state.map);else state.map.removeLayer(state.layers.hike)}
    function hookUI(){document.getElementById('chkRoad').addEventListener('change',applyFilters);document.getElementById('chkRail').addEventListener('change',applyFilters);document.getElementById('chkHike').addEventListener('change',applyFilters);document.getElementById('resetBtn').addEventListener('click',()=>{document.getElementById('chkRoad').checked=true;document.getElementById('chkRail').checked=true;document.getElementById('chkHike').checked=true;document.getElementById('scenicPref').checked=true;document.getElementById('noTolls').checked=false;applyFilters()})}
    async function loadSpec(){const paths=['data/itinerary_spec.txt','./data/itinerary_spec.txt','/usa-van-rail-site/data/itinerary_spec.txt'];for(const p of paths){try{const r=await fetch(p,{cache:'no-cache'});if(r.ok){const txt=await r.text();return jsyaml.load(txt)}}catch(_){}}throw new Error('Could not load data/itinerary_spec.txt')}
    (async()=>{try{initMap();hookUI();const spec=await loadSpec();state.spec=spec;const daysEl=document.getElementById('days');const bounds=L.latLngBounds([]);for(const day of (spec.days||[])){daysEl.appendChild(buildDayCard(day));addPoints(day.points);const mapById=byId(day.points);await addSegments(day,mapById);(day.points||[]).forEach(p=>{if(p.coords)bounds.extend([p.coords.lat,p.coords.lng])})}if(bounds.isValid())state.map.fitBounds(bounds.pad(0.2));applyFilters()}catch(e){console.error(e);const el=document.getElementById('days');const div=document.createElement('div');div.className="p-4 text-sm text-red-700 bg-red-50 border border-red-200 rounded-xl m-3";div.innerHTML="Failed to initialize the map or load itinerary. Open DevTools Console for details.";el.appendChild(div)}})();
  </script>
</body>
</html>
