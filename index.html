<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>USA Van + Rail Itinerary — Starter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    html, body { height: 100%; }
    #map { height: 50vh; }
    .leaflet-popup { pointer-events: auto; } /* avoid closing on first click */
    .seg-badge { font-size: 0.75rem; }
    .seg-rv { background: #2563eb; color: white; }
    .seg-train { background: #059669; color: white; }
    .seg-walk { background: #6b7280; color: white; }
    .seg-dashed { stroke-dasharray: 6 8; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b border-gray-200">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-xl font-semibold">USA Van + Rail Itinerary — Starter</h1>
      <div class="ml-auto flex items-center gap-2">
        <label class="text-sm">Show:</label>
        <select id="filterMode" class="text-sm border rounded-md px-2 py-1">
          <option value="all">All</option>
          <option value="rv_train">RV + Train only</option>
          <option value="city_walk">City / Walk-Transit only</option>
        </select>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 pt-3 pb-24">
    <div id="map" class="rounded-2xl shadow"></div>
    <p class="mt-2 text-xs text-gray-500">Map tiles © OpenStreetMap contributors. Light usage intended.</p>

    <section id="days" class="mt-6 space-y-4"></section>
  </main>

  <script>
    const state = {
      data: null,
      map: null,
      layers: { points: [], segments: [] }
    };

    async function loadData() {
      const res = await fetch('./data/itinerary_spec.txt');
      const text = await res.text();
      try {
        state.data = JSON.parse(text);
      } catch (e) {
        console.error('Failed to parse itinerary_spec.txt', e);
        alert('itinerary_spec.txt parse error. Check JSON.');
      }
    }

    function initMap() {
      state.map = L.map('map', { zoomControl: true });
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
      }).addTo(state.map);
      state.map.setView([41.88, -87.63], 6);
    }

    function clearMap() {
      state.layers.points.forEach(l => l.remove());
      state.layers.segments.forEach(l => l.remove());
      state.layers.points = [];
      state.layers.segments = [];
    }

    function modeToBadge(mode) {
      if (mode === 'rv') return '<span class="seg-badge seg-rv rounded px-2 py-0.5">RV</span>';
      if (mode === 'train') return '<span class="seg-badge seg-train rounded px-2 py-0.5">Train</span>';
      return '<span class="seg-badge seg-walk rounded px-2 py-0.5">Walk/Transit</span>';
    }

    function shouldShowSegment(mode, filter) {
      if (filter === 'all') return true;
      if (filter === 'rv_train') return (mode === 'rv' || mode === 'train');
      if (filter === 'city_walk') return (mode !== 'rv' && mode !== 'train');
      return true;
    }

    function polylineFromEncoded(encoded) {
      // Very small placeholder: treat "}" as sample tiny polyline; empty => dashed between centroids
      if (!encoded) return null;
      // Demo: return a short line between Chicago and MSP
      return [[41.8786, -87.6405], [44.9707, -93.2313]];
    }

    function render(filter = 'all') {
      clearMap();
      const bounds = L.latLngBounds([]);

      // points
      state.data.days.forEach(day => {
        day.points.forEach(p => {
          const marker = L.marker([p.coords[0], p.coords[1]]).addTo(state.map);
          marker.bindPopup(`
            <div class="space-y-1">
              <div class="font-semibold">${p.name}</div>
              <div class="text-xs text-gray-600">${p.type} • stay ~${p.stay_duration_min} min</div>
              <div class="text-xs">${p.description || ''}</div>
              ${(p.links||[]).map(l => `<a class="text-blue-600 underline text-xs" href="${l.url}" target="_blank" rel="noopener">${l.title}</a>`).join(' ')}
            </div>
          `, { autoClose: false, closeButton: true });
          state.layers.points.push(marker);
          bounds.extend([p.coords[0], p.coords[1]]);
        });
      });

      // segments
      state.data.days.forEach(day => {
        day.segments.forEach(seg => {
          if (!shouldShowSegment(seg.mode, filter)) return;
          let latlngs = null;
          let dashed = false;
          if (seg.polyline) {
            latlngs = polylineFromEncoded(seg.polyline);
          } else {
            // draw a straight dashed line between from/to points
            const from = findPoint(seg.from_point_id);
            const to = findPoint(seg.to_point_id);
            if (from && to) {
              latlngs = [from.coords, to.coords];
              dashed = true;
            }
          }
          if (latlngs) {
            const line = L.polyline(latlngs, {
              weight: 4,
              opacity: 0.9,
              color: (seg.mode === 'train' ? '#059669' : seg.mode === 'rv' ? '#2563eb' : '#6b7280'),
              dashArray: dashed ? '6,8' : null
            }).addTo(state.map);
            line.bindPopup(`<div>${modeToBadge(seg.mode)} <span class="ml-2 text-xs text-gray-600">${day.title}</span></div>`, { autoClose: false });
            state.layers.segments.push(line);
            latlngs.forEach(ll => bounds.extend(ll));
          }
        });
      });

      if (bounds.isValid()) state.map.fitBounds(bounds.pad(0.2));
    }

    function findPoint(id) {
      for (const d of state.data.days) {
        const p = d.points.find(pp => pp.id === id);
        if (p) return p;
      }
      return null;
    }

    function renderDayCards() {
      const root = document.getElementById('days');
      root.innerHTML = '';
      const anchor = new Date(state.data.meta.date_anchor + 'T00:00:00');
      state.data.days.forEach((day, idx) => {
        const date = new Date(anchor);
        date.setDate(anchor.getDate() + (day.date_offset_days || 0));
        const dateStr = date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });

        const segBadges = day.segments.map(s => modeToBadge(s.mode)).join(' ');

        const pointsHtml = day.points.map(p => `
          <li class="flex items-start gap-3">
            <div class="w-2 h-2 rounded-full bg-gray-400 mt-2"></div>
            <div>
              <div class="font-medium">${p.name}</div>
              <div class="text-xs text-gray-600">${p.type} • ~${p.stay_duration_min} min</div>
              <div class="text-sm">${p.description || ''}</div>
              <div class="mt-1 flex flex-wrap gap-2">
                ${(p.links||[]).map(l => `<a class="text-blue-600 underline text-xs" href="${l.url}" target="_blank" rel="noopener">${l.title}</a>`).join(' ')}
              </div>
            </div>
          </li>
        `).join('');

        const card = document.createElement('article');
        card.className = 'bg-white rounded-2xl shadow p-4';
        card.innerHTML = `
          <div class="flex items-center gap-2 mb-2">
            <h3 class="text-lg font-semibold">Day ${idx+1}: ${day.title}</h3>
            <span class="text-sm text-gray-600">(${dateStr})</span>
            <div class="ml-auto flex items-center gap-2">${segBadges}</div>
          </div>
          <ul class="space-y-3">${pointsHtml}</ul>
          <div class="mt-3 text-sm text-gray-600"><span class="font-medium">Sleep:</span> ${day.sleep?.name || '—'}</div>
        `;
        root.appendChild(card);
      });
    }

    document.getElementById('filterMode').addEventListener('change', (e) => {
      render(e.target.value);
    });

    (async function() {
      await loadData();
      initMap();
      renderDayCards();
      render('all');
    })();
  </script>
</body>
</html>