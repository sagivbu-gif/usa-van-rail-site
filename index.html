<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>USA Van + Rail Itinerary (Slim Map 15 days)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.1.0/turf.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #map { height: 60vh; }
    .leaflet-popup-content { margin: 8px 10px; }
    .chip { @apply inline-flex items-center px-2 py-1 text-xs rounded-full bg-gray-100 border; }
  </style>
</head>
<body class="bg-white text-gray-900">
  <header class="p-4 border-b sticky top-0 bg-white z-40">
    <div class="flex items-center justify-between gap-3">
      <h1 class="text-lg font-bold">USA Van + Rail — 15‑day Slim Map</h1>
      <div class="flex items-center gap-2">
        <label class="text-sm">Mode:</label>
        <select id="modeFilter" class="border rounded px-2 py-1 text-sm">
          <option value="all" selected>All</option>
          <option value="road">Road</option>
          <option value="rail">Rail</option>
          <option value="hike">Hike</option>
        </select>
        <label class="text-sm">Scenic:</label>
        <select id="scenicPref" class="border rounded px-2 py-1 text-sm">
          <option value="auto" selected>Auto</option>
          <option value="scenic">Prefer Scenic</option>
          <option value="fastest">Prefer Fastest</option>
        </select>
      </div>
    </div>
  </header>

  <main class="p-4">
    <div id="map" class="rounded-xl border mb-4"></div>
    <div id="legend" class="text-sm mb-4 space-y-2">
      <div><span class="chip">Road (live OSRM)</span> <span class="chip">Rail (fixed)</span> <span class="chip">Hike (fixed)</span> <span class="chip">Dashed = placeholder</span></div>
      <div id="warnings" class="text-amber-700"></div>
    </div>

    <section id="days" class="space-y-3"></section>
  </main>

  <script>
    // Load itinerary
    async function loadItinerary() {
      const res = await fetch('data/itinerary_spec.txt');
      return res.json();
    }

    const map = L.map('map', { scrollWheelZoom: true });
    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const roadLayerGroup = L.layerGroup().addTo(map);
    const fixedLayerGroup = L.layerGroup().addTo(map);
    const markerLayer = L.layerGroup().addTo(map);

    const bounds = L.latLngBounds([]);
    const routeControls = []; // store L.Routing.Control for roads

    function addMarker(p) {
      const m = L.marker([p.coords[0], p.coords[1]]).addTo(markerLayer);
      m.bindPopup(`<b>${p.name}</b><br/><span class='text-xs'>${p.type}</span><br/>Stay ~${p.stay_duration_min} min`,
        { autoClose: false, closeOnClick: false });
      bounds.extend([p.coords[0], p.coords[1]]);
    }

    function addFixedPolyline(coords, mode) {
      const color = mode === 'rail' ? '#0ea5e9' : '#16a34a';
      const dashArray = mode === 'placeholder' ? '6,6' : null;
      const pl = L.polyline(coords.map(c => [c[0], c[1]]), { color, weight: 4, dashArray }).addTo(fixedLayerGroup);
      return pl;
    }

    function routeRoad(fromPt, toPt, scenicPreferred) {
      // scenicPreferred: 'scenic'|'fastest'|'auto'
      // We'll switch OSRM profiles: 'driving' for fastest; for scenic we add hints (no actual OSRM scenic profile here, but we can force alternatives and pick the one with lower motorway share).
      const plan = L.Routing.plan([
        L.latLng(fromPt.coords[0], fromPt.coords[1]),
        L.latLng(toPt.coords[0], toPt.coords[1])
      ], {
        createMarker: () => null
      });

      const control = L.Routing.control({
        plan,
        lineOptions: { styles: [{ color: '#ef4444', weight: 5, opacity: 0.9 }]},
        router: L.Routing.osrmv1({
          serviceUrl: 'https://router.project-osrm.org/route/v1',
          profile: 'driving',
          useHints: true
        }),
        routeWhileDragging: false,
        show: false,
        addWaypoints: false,
        waypointMode: 'snap',
        alternatives: true
      }).addTo(roadLayerGroup);

      control.on('routesfound', (e) => {
        let chosen = e.routes[0];
        if (scenicPreferred === 'scenic' || (scenicPreferred === 'auto' && (toPt.scenic_preferred || fromPt.scenic_preferred))) {
          // naive scenic heuristic: choose alternative with shortest motorway percentage
          let best = e.routes[0], bestScore = 1e9;
          e.routes.forEach(r => {
            const mway = (r.instructions || []).filter(i => /motorway/i.test(i.text)).length;
            const score = mway * 1000 + r.summary.totalTime; // prioritize fewer motorways, then time
            if (score < bestScore) { best = r; bestScore = score; }
          });
          chosen = best;
        } else if (scenicPreferred === 'fastest') {
          let best = e.routes[0];
          e.routes.forEach(r => { if (r.summary.totalTime < best.summary.totalTime) best = r; });
          chosen = best;
        }
        // Replace with chosen route
        control.setRoutes([chosen]);
        const latlngs = chosen.coordinates.map(c => [c.lat, c.lng]);
        latlngs.forEach(ll => bounds.extend(ll));
        map.fitBounds(bounds.pad(0.15));
      });

      routeControls.push(control);
      return control;
    }

    function clearRoadRoutes() {
      routeControls.forEach(rc => {
        try { roadLayerGroup.removeLayer(rc); } catch(e) {}
      });
      routeControls.length = 0;
    }

    function renderDays(days, scenicPrefValue) {
      const daysEl = document.getElementById('days');
      daysEl.innerHTML = '';
      clearRoadRoutes();
      fixedLayerGroup.clearLayers();
      markerLayer.clearLayers();
      const warningsEl = document.getElementById('warnings');
      warningsEl.innerHTML = '';

      days.forEach(d => {
        // Points & markers
        (d.points || []).forEach(addMarker);

        // Segments
        (d.segments || []).forEach(seg => {
          const from = (d.points || []).find(p => p.id === seg.from) || findPointById(days, seg.from);
          const to = (d.points || []).find(p => p.id === seg.to) || findPointById(days, seg.to);
          if (!from || !to) return;

          if (seg.mode === 'road') {
            routeRoad(from, to, scenicPrefValue);
          } else if (seg.mode === 'rail' || seg.mode === 'hike') {
            if (seg.polyline && seg.polyline.length > 1) {
              addFixedPolyline(seg.polyline, seg.mode);
            } else {
              // dashed placeholder
              const dashed = addFixedPolyline([from.coords, to.coords], 'placeholder');
              warningsEl.innerHTML += `<div>Day ${d.day}: ${seg.mode} has no polyline — showing dashed placeholder.</div>`;
            }
          }
        });

        // Day card
        const card = document.createElement('div');
        card.className = 'border rounded-lg p-3';
        const ptsList = (d.points || []).map(p => `<li class="text-sm"><b>${p.name}</b> <span class="chip ml-1">${p.type}</span></li>`).join('');
        const segList = (d.segments || []).map(s => `<li class="text-xs">${s.mode.toUpperCase()} ${s.scenic_preferred ? '• scenic' : ''} ${s.polyline ? '• fixed' : ''}</li>`).join('');
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Day ${d.day}: ${d.title}</h3>
            <div class="text-xs text-gray-500">${(d.segments||[]).length} segments</div>
          </div>
          <div class="mt-2">
            <div class="text-xs font-medium mb-1">Points</div>
            <ul class="list-disc ml-5 space-y-1">${ptsList}</ul>
          </div>
          <div class="mt-2">
            <div class="text-xs font-medium mb-1">Segments</div>
            <ul class="list-disc ml-5 space-y-1">${segList || '<li class="text-xs">—</li>'}</ul>
          </div>
        `;
        daysEl.appendChild(card);
      });

      if (bounds.isValid()) {
        map.fitBounds(bounds.pad(0.12));
      } else {
        map.setView([39.5, -98.35], 4);
      }
    }

    function findPointById(days, id) {
      for (const d of days) {
        const p = (d.points || []).find(x => x.id === id);
        if (p) return p;
      }
      return null;
    }

    (async () => {
      const data = await loadItinerary();
      renderDays(data.days.slice(0, 15), document.getElementById('scenicPref').value);

      document.getElementById('modeFilter').addEventListener('change', (e) => {
        const v = e.target.value;
        // Simple visibility toggles by redrawing
        renderDays(itinerary.days.slice(0, 15), document.getElementById('scenicPref').value);
      });

      document.getElementById('scenicPref').addEventListener('change', (e) => {
        const v = e.target.value;
        renderDays(itinerary.days.slice(0, 15), v);
      });

      // keep a reference for re-render
      window.itinerary = data;
    })();
  </script>
</body>
</html>
