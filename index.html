<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>USA Van + Rail Itinerary</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    html, body { height: 100%; }
    #map { height: 55vh; }
    .seg-badge { font-size: 0.72rem; }
    .seg-rv { background: #2563eb; color: #fff; }
    .seg-train { background: #059669; color: #fff; }
    .seg-walk { background: #6b7280; color: #fff; }
    .leaflet-popup { pointer-events: auto; }
    .tab-active { border-bottom: 2px solid #111827; color: #111827; }
    .tab-inactive { color: #6b7280; }
    .dash { stroke-dasharray: 6 8; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header / Nav -->
  <header class="sticky top-0 z-40 bg-white/95 backdrop-blur border-b border-gray-200">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex items-center gap-3 py-3">
        <div class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 13.5l7.5-7.5 6 6L21 7.5"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 20.25h18"/></svg>
          <h1 class="text-lg sm:text-xl font-semibold">USA Van + Rail Itinerary</h1>
        </div>
        <nav class="ml-auto flex items-end gap-5 text-sm">
          <button data-tab="itinerary" class="tab-btn tab-active pb-2">Itinerary</button>
          <button data-tab="van" class="tab-btn tab-inactive pb-2">Van</button>
          <button data-tab="about" class="tab-btn tab-inactive pb-2">About</button>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 pb-20">
    <!-- ITINERARY TAB -->
    <section id="tab-itinerary" class="pt-4">
      <div class="bg-white rounded-2xl shadow p-3 sm:p-4">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <div class="flex items-center gap-2">
            <label for="filterMode" class="text-sm text-gray-700 whitespace-nowrap">Show:</label>
            <select id="filterMode" class="text-sm border rounded-md px-2 py-1">
              <option value="all">All</option>
              <option value="rv_train">RV + Train only</option>
              <option value="city_walk">City / Walk-Transit only</option>
            </select>
          </div>
          <div class="text-xs text-gray-500 sm:ml-auto">Dashed lines = draft (no polyline yet)</div>
        </div>
        <div id="map" class="rounded-xl mt-3"></div>
        <p class="mt-2 text-xs text-gray-500">Map tiles © OpenStreetMap contributors. Keep usage light.</p>
      </div>

      <div id="days" class="mt-4 space-y-4"></div>
    </section>

    <!-- VAN TAB -->
    <section id="tab-van" class="hidden pt-6">
      <div id="vanCard" class="bg-white rounded-2xl shadow p-5"></div>
    </section>

    <!-- ABOUT TAB -->
    <section id="tab-about" class="hidden pt-6">
      <article class="bg-white rounded-2xl shadow p-5 space-y-3 text-sm leading-6">
        <h2 class="text-lg font-semibold">About this site</h2>
        <p>This is a single-file static site. Content comes from <code>/data/itinerary_spec.txt</code> if present. If the file is missing, it falls back to the embedded JSON below.</p>
        <ul class="list-disc pl-5">
          <li>Update trip details by editing <code>data/itinerary_spec.txt</code> in your repo.</li>
          <li>For precise routes, add an encoded <code>polyline</code> to each segment; otherwise a dashed line between points is drawn.</li>
          <li>Tabs: <em>Itinerary</em> shows map and days; <em>Van</em> renders RV meta info; <em>About</em> has instructions.</li>
        </ul>
        <h3 class="font-semibold mt-4">Quick GitHub Pages tips</h3>
        <ol class="list-decimal pl-5">
          <li>Repo root must contain <code>index.html</code> and the folder <code>data/</code> with <code>itinerary_spec.txt</code>.</li>
          <li>Settings → Pages → Deploy from a branch → <code>main</code> + <code>/(root)</code>.</li>
        </ol>
      </article>
    </section>
  </main>

  <!-- Inline fallback data (used only if fetch to /data/itinerary_spec.txt fails) -->
  <script id="itinerary-spec" type="application/json">
  {
    "schema_version": "2",
    "meta": {
      "date_anchor": "2026-08-27",
      "timezone": "Asia/Jerusalem",
      "units": "imperial",
      "van": {
        "type": "Class C",
        "length_ft": 28,
        "sleeping": "2 adults + 1 child",
        "seatbelts": 4,
        "tanks": {"fresh_gal": 40, "grey_gal": 30, "black_gal": 30},
        "pickup": {"city": "Chicago, IL", "datetime_local": "2026-08-27T10:00"},
        "dropoff": {"city": "Seattle, WA", "datetime_local": "2026-09-10T10:00"}
      }
    },
    "defaults": {
      "price_estimate": {
        "national_park_entry_vehicle": 35,
        "city_parking_hour": 4,
        "public_lot_day": 15,
        "rv_hookup_night": 55,
        "museum_adult": 25
      }
    },
    "days": [
      {
        "id": "day1",
        "title": "Chicago arrival & RV pickup",
        "date_offset_days": 0,
        "sleep": {"type": "rv_park", "name": "Chicago Northwest KOA (demo)"},
        "segments": [
          {"mode": "rv", "from_point_id": "chi_pickup", "to_point_id": "koa_camp", "polyline": "", "alt_routes": {"no_tolls": false}}
        ],
        "points": [
          {"id": "chi_pickup","slug":"chicago-rv-pickup","name":"RV Pickup – Cruise America Chicago (demo)","type":"logistics","coords":[41.8781,-87.6298],"stay_duration_min":90,"description":"Vehicle orientation & paperwork.","links":[{"title":"Website","url":"https://www.cruiseamerica.com/"}],"parking":"On site","price_estimate":null},
          {"id": "koa_camp","slug":"chicago-koa","name":"Chicago Northwest KOA (demo)","type":"rv_camp","coords":[42.1,-88.3],"stay_duration_min":720,"description":"Full hookups, showers, laundry.","links":[],"parking":"Pull-through sites; check-in after 1pm.","price_estimate":{"rv_hookup_night":55}}
        ]
      },
      {
        "id": "day2",
        "title": "Chicago city day (RV parked)",
        "date_offset_days": 1,
        "sleep": {"type": "rv_park", "name": "Chicago Northwest KOA (demo)"},
        "segments": [
          {"mode": "walk_transit", "from_point_id": "millennium_park", "to_point_id": "art_institute", "polyline": ""}
        ],
        "points": [
          {"id":"millennium_park","slug":"millennium-park","name":"Millennium Park","type":"city_landmark","coords":[41.8826,-87.6226],"stay_duration_min":90,"description":"The Bean, gardens, fountains.","links":[{"title":"Official site","url":"https://www.chicago.gov/"}],"parking":"Use public garages; RV stays at KOA","price_estimate":{"city_parking_hour":4}},
          {"id":"art_institute","slug":"art-institute","name":"The Art Institute of Chicago","type":"museum","coords":[41.8796,-87.6237],"stay_duration_min":150,"description":"World-class collection. Buy timed tickets.","links":[{"title":"Tickets","url":"https://www.artic.edu/"}],"parking":"Public garage nearby","price_estimate":{"museum_adult":25}}
        ]
      },
      {
        "id": "day3",
        "title": "Empire Builder to Minneapolis (Amtrak)",
        "date_offset_days": 2,
        "sleep": {"type": "hotel", "name": "Downtown Minneapolis (demo)"},
        "segments": [
          {
            "mode": "train",
            "amtrak_line": "Empire Builder",
            "from_point_id": "chi_union",
            "to_point_id": "msn_union",
            "polyline": "}",
            "notes": "Demo polyline renders a straight sample between stations"
          }
        ],
        "points": [
          {"id":"chi_union","slug":"chicago-union-station","name":"Chicago Union Station","type":"train_station","coords":[41.8786,-87.6405],"stay_duration_min":60,"description":"Board Amtrak Empire Builder.","links":[{"title":"Amtrak","url":"https://www.amtrak.com/"}],"parking":"Taxi/Transit from KOA Park & Ride","price_estimate":null},
          {"id":"msn_union","slug":"minneapolis-st-paul","name":"Minneapolis–St. Paul (Midway Stn)","type":"train_station","coords":[44.9707,-93.2313],"stay_duration_min":45,"description":"Arrive & transfer to hotel.","links":[], "parking":"Hotel valet/self-park","price_estimate":null}
        ]
      }
    ]
  }
  </script>

  <script>
    // --- Utilities ---
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // Polyline decoder (Google algorithm). Returns [[lat,lng], ...]
    function decodePolyline(str) {
      if (!str || typeof str !== 'string') return null;
      let index = 0, lat = 0, lng = 0, coordinates = [];
      while (index < str.length) {
        let b, shift = 0, result = 0;
        do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
        const dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lat += dlat;
        shift = 0; result = 0;
        do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
        const dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lng += dlng;
        coordinates.push([lat * 1e-5, lng * 1e-5]);
      }
      return coordinates;
    }

    // --- App State ---
    const state = {
      data: null,
      map: null,
      layers: { points: [], segments: [] },
      lastFilter: 'all'
    };

    // --- Tab logic ---
    function switchTab(tab) {
      $$('.tab-btn').forEach(btn => {
        const active = btn.dataset.tab === tab;
        btn.classList.toggle('tab-active', active);
        btn.classList.toggle('tab-inactive', !active);
      });
      $('#tab-itinerary').classList.toggle('hidden', tab !== 'itinerary');
      $('#tab-van').classList.toggle('hidden', tab !== 'van');
      $('#tab-about').classList.toggle('hidden', tab !== 'about');
      localStorage.setItem('tab', tab);
      if (tab === 'itinerary' && state.map) { setTimeout(() => state.map.invalidateSize(), 200); }
    }

    // --- Data Loading ---
    async function loadData() {
      try {
        const res = await fetch('./data/itinerary_spec.txt', { cache: 'no-store' });
        if (!res.ok) throw new Error('not found');
        const txt = await res.text();
        return JSON.parse(txt);
      } catch (e) {
        // fallback to inline
        const inline = $('#itinerary-spec')?.textContent;
        return JSON.parse(inline);
      }
    }

    // --- Map Init ---
    function initMap() {
      state.map = L.map('map', {
        zoomControl: true,
        closePopupOnClick: false
      });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
      }).addTo(state.map);
      state.map.setView([41.88, -87.63], 6);
    }

    function clearMap() {
      state.layers.points.forEach(l => l.remove());
      state.layers.segments.forEach(l => l.remove());
      state.layers.points = [];
      state.layers.segments = [];
    }

    function modeBadge(mode) {
      if (mode === 'rv') return '<span class="seg-badge seg-rv rounded px-2 py-0.5">RV</span>';
      if (mode === 'train') return '<span class="seg-badge seg-train rounded px-2 py-0.5">Train</span>';
      return '<span class="seg-badge seg-walk rounded px-2 py-0.5">Walk/Transit</span>';
    }

    function shouldShow(mode, filter) {
      if (filter === 'all') return true;
      if (filter === 'rv_train') return (mode === 'rv' || mode === 'train');
      if (filter === 'city_walk') return (mode !== 'rv' && mode !== 'train');
      return true;
    }

    function findPoint(id) {
      for (const d of state.data.days) {
        const p = d.points.find(pp => pp.id === id);
        if (p) return p;
      }
      return null;
    }

    function renderMap(filter = 'all') {
      clearMap();
      const bounds = L.latLngBounds([]);

      // Points
      state.data.days.forEach(day => {
        day.points.forEach(p => {
          const marker = L.marker([p.coords[0], p.coords[1]]).addTo(state.map);
          const links = (p.links || []).map(l => `<a class="text-blue-600 underline text-xs" href="${l.url}" target="_blank" rel="noopener">${l.title}</a>`).join(' ');
          marker.bindPopup(`
            <div class="space-y-1">
              <div class="font-semibold">${p.name}</div>
              <div class="text-xs text-gray-600">${p.type} • stay ~${p.stay_duration_min} min</div>
              <div class="text-xs">${p.description || ''}</div>
              <div class="flex gap-2 flex-wrap mt-1">${links}</div>
            </div>
          `, { autoClose: false, closeButton: true });
          state.layers.points.push(marker);
          bounds.extend([p.coords[0], p.coords[1]]);
        });
      });

      // Segments
      state.data.days.forEach(day => {
        day.segments.forEach(seg => {
          if (!shouldShow(seg.mode, filter)) return;
          let latlngs = null;
          let dashed = false;
          if (seg.polyline && seg.polyline.trim()) {
            const decoded = decodePolyline(seg.polyline.trim());
            if (decoded && decoded.length > 1) latlngs = decoded;
          }
          if (!latlngs) {
            const a = findPoint(seg.from_point_id);
            const b = findPoint(seg.to_point_id);
            if (a && b) { latlngs = [a.coords, b.coords]; dashed = true; }
          }
          if (latlngs) {
            const color = seg.mode === 'train' ? '#059669' : (seg.mode === 'rv' ? '#2563eb' : '#6b7280');
            const line = L.polyline(latlngs, {
              weight: 4,
              opacity: 0.95,
              color,
              dashArray: dashed ? '6,8' : null
            }).addTo(state.map);
            line.bindPopup(`<div>${modeBadge(seg.mode)} <span class="ml-2 text-xs text-gray-600">${day.title}</span></div>`, { autoClose: false });
            state.layers.segments.push(line);
            latlngs.forEach(ll => bounds.extend(ll));
          }
        });
      });

      if (bounds.isValid()) state.map.fitBounds(bounds.pad(0.2));
    }

    function renderDays() {
      const root = $('#days');
      root.innerHTML = '';
      const anchor = new Date(state.data.meta.date_anchor + 'T00:00:00');

      state.data.days.forEach((day, idx) => {
        const date = new Date(anchor);
        date.setDate(anchor.getDate() + (day.date_offset_days || 0));
        const dateStr = date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        const segBadges = day.segments.map(s => modeBadge(s.mode)).join(' ');

        const pointsHtml = day.points.map(p => `
          <li class="flex items-start gap-3">
            <div class="w-2 h-2 rounded-full bg-gray-400 mt-2"></div>
            <div>
              <div class="font-medium">${p.name}</div>
              <div class="text-xs text-gray-600">${p.type} • ~${p.stay_duration_min} min</div>
              <div class="text-sm">${p.description || ''}</div>
              <div class="mt-1 flex flex-wrap gap-2">
                ${(p.links||[]).map(l => `<a class="text-blue-600 underline text-xs" href="${l.url}" target="_blank" rel="noopener">${l.title}</a>`).join(' ')}
              </div>
            </div>
          </li>
        `).join('');

        const sleepText = day.sleep?.name ? `${day.sleep.name}${day.sleep.type ? ` • ${day.sleep.type}` : ''}` : '—';

        const card = document.createElement('article');
        card.className = 'bg-white rounded-2xl shadow p-4';
        card.innerHTML = `
          <div class="flex items-center gap-2 mb-2">
            <h3 class="text-lg font-semibold">Day ${idx+1}: ${day.title}</h3>
            <span class="text-sm text-gray-600">(${dateStr})</span>
            <div class="ml-auto flex items-center gap-2">${segBadges}</div>
          </div>
          <ul class="space-y-3">${pointsHtml}</ul>
          <div class="mt-3 text-sm text-gray-600"><span class="font-medium">Sleep:</span> ${sleepText}</div>
        `;
        root.appendChild(card);
      });
    }

    function renderVan() {
      const v = state.data?.meta?.van;
      const el = $('#vanCard');
      if (!v) { el.innerHTML = '<div class="text-sm text-gray-600">No van data in spec.</div>'; return; }
      el.innerHTML = `
        <div class="flex flex-col sm:flex-row gap-5">
          <div class="flex-1 space-y-2">
            <h2 class="text-xl font-semibold">Van Details</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
              <div><div class="text-gray-500">Type</div><div class="font-medium">${v.type||'-'}</div></div>
              <div><div class="text-gray-500">Length</div><div class="font-medium">${v.length_ft||'-'} ft</div></div>
              <div><div class="text-gray-500">Sleeping</div><div class="font-medium">${v.sleeping||'-'}</div></div>
              <div><div class="text-gray-500">Seatbelts</div><div class="font-medium">${v.seatbelts||'-'}</div></div>
              <div><div class="text-gray-500">Fresh Tank</div><div class="font-medium">${v.tanks?.fresh_gal||'-'} gal</div></div>
              <div><div class="text-gray-500">Grey/Black</div><div class="font-medium">${v.tanks?.grey_gal||'-'}/${v.tanks?.black_gal||'-'} gal</div></div>
            </div>
          </div>
          <div class="flex-1 space-y-2">
            <h3 class="text-lg font-semibold">Logistics</h3>
            <div class="text-sm">
              <div class="text-gray-500">Pickup</div>
              <div class="font-medium">${v.pickup?.city||'-'} • ${v.pickup?.datetime_local||'-'}</div>
            </div>
            <div class="text-sm mt-2">
              <div class="text-gray-500">Dropoff</div>
              <div class="font-medium">${v.dropoff?.city||'-'} • ${v.dropoff?.datetime_local||'-'}</div>
            </div>
          </div>
        </div>
      `;
    }

    // Filter change
    $('#filterMode').addEventListener('change', (e) => {
      state.lastFilter = e.target.value;
      renderMap(state.lastFilter);
    });

    // Tab click handlers
    $$('.tab-btn').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));

    // Init
    (async function init() {
      state.data = await loadData();
      initMap();
      renderDays();
      renderMap(state.lastFilter);
      renderVan();

      // Restore last tab or default
      const saved = localStorage.getItem('tab') || 'itinerary';
      switchTab(saved);
    })();
  </script>
</body>
</html>